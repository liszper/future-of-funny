shadow$provide.module$node_modules$engine_DOT_io_client$build$cjs$transports$polling=function(global,require,module,exports){function empty(){}function unloadHandler(){for(let i in Request.requests)Request.requests.hasOwnProperty(i)&&Request.requests[i].abort()}module=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{"default":mod}};Object.defineProperty(exports,"__esModule",{value:!0});exports.Request=exports.Polling=void 0;global=require("module$node_modules$engine_DOT_io_client$build$cjs$transport");
module=module(require("module$node_modules$engine_DOT_io_client$node_modules$debug$src$browser"));const yeast_js_1=require("module$node_modules$engine_DOT_io_client$build$cjs$contrib$yeast"),parseqs_js_1=require("module$node_modules$engine_DOT_io_client$build$cjs$contrib$parseqs"),engine_io_parser_1=require("module$node_modules$engine_DOT_io_parser$build$cjs$index"),xmlhttprequest_js_1=require("module$node_modules$engine_DOT_io_client$build$cjs$transports$xmlhttprequest_browser"),component_emitter_1=
require("module$node_modules$$socket_DOT_io$component_emitter$index"),util_js_1=require("module$node_modules$engine_DOT_io_client$build$cjs$util");require=require("module$node_modules$engine_DOT_io_client$build$cjs$globalThis_browser");const debug=(0,module.default)("engine.io-client:polling"),hasXHR2=null!=(new xmlhttprequest_js_1.XHR({xdomain:!1})).responseType;class Polling extends global.Transport{constructor(opts){super(opts);this.polling=!1;if("undefined"!==typeof location){const isSSL="https:"===
location.protocol;let port=location.port;port||=isSSL?"443":"80";this.xd="undefined"!==typeof location&&opts.hostname!==location.hostname||port!==opts.port;this.xs=opts.secure!==isSSL}opts=opts&&opts.forceBase64;this.supportsBinary=hasXHR2&&!opts}get name(){return"polling"}doOpen(){this.poll()}pause(onPause){this.readyState="pausing";const pause=()=>{debug("paused");this.readyState="paused";onPause()};if(this.polling||!this.writable){let total=0;this.polling&&(debug("we are currently polling - waiting to pause"),
total++,this.once("pollComplete",function(){debug("pre-pause polling complete");--total||pause()}));this.writable||(debug("we are currently writing - waiting to pause"),total++,this.once("drain",function(){debug("pre-pause writing complete");--total||pause()}))}else pause()}poll(){debug("polling");this.polling=!0;this.doPoll();this.emitReserved("poll")}onData(data){debug("polling got data %s",data);(0,engine_io_parser_1.decodePayload)(data,this.socket.binaryType).forEach(packet=>{if("opening"===this.readyState&&
"open"===packet.type)this.onOpen();if("close"===packet.type)return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(packet)});"closed"!==this.readyState&&(this.polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState?this.poll():debug('ignoring poll - transport state "%s"',this.readyState))}doClose(){const close=()=>{debug("writing close packet");this.write([{type:"close"}])};"open"===this.readyState?(debug("transport open - closing"),close()):(debug("transport not open - deferring close"),
this.once("open",close))}write(packets){this.writable=!1;(0,engine_io_parser_1.encodePayload)(packets,data=>{this.doWrite(data,()=>{this.writable=!0;this.emitReserved("drain")})})}uri(){var query=this.query||{};const schema=this.opts.secure?"https":"http";let port="";!1!==this.opts.timestampRequests&&(query[this.opts.timestampParam]=(0,yeast_js_1.yeast)());this.supportsBinary||query.sid||(query.b64=1);this.opts.port&&("https"===schema&&443!==Number(this.opts.port)||"http"===schema&&80!==Number(this.opts.port))&&
(port=":"+this.opts.port);query=(0,parseqs_js_1.encode)(query);const ipv6=-1!==this.opts.hostname.indexOf(":");return schema+"://"+(ipv6?"["+this.opts.hostname+"]":this.opts.hostname)+port+this.opts.path+(query.length?"?"+query:"")}request(opts={}){Object.assign(opts,{xd:this.xd,xs:this.xs},this.opts);return new Request(this.uri(),opts)}doWrite(data,fn){data=this.request({method:"POST",data});data.on("success",fn);data.on("error",(xhrStatus,context)=>{this.onError("xhr post error",xhrStatus,context)})}doPoll(){debug("xhr poll");
const req=this.request();req.on("data",this.onData.bind(this));req.on("error",(xhrStatus,context)=>{this.onError("xhr poll error",xhrStatus,context)});this.pollXhr=req}}exports.Polling=Polling;class Request extends component_emitter_1.Emitter{constructor(uri,opts){super();(0,util_js_1.installTimerFunctions)(this,opts);this.opts=opts;this.method=opts.method||"GET";this.uri=uri;this.async=!1!==opts.async;this.data=void 0!==opts.data?opts.data:null;this.create()}create(){const opts=(0,util_js_1.pick)(this.opts,
"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");opts.xdomain=!!this.opts.xd;opts.xscheme=!!this.opts.xs;const xhr=this.xhr=new xmlhttprequest_js_1.XHR(opts);try{debug("xhr open %s: %s",this.method,this.uri);xhr.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders){xhr.setDisableHeaderCheck&&xhr.setDisableHeaderCheck(!0);for(let i in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(i)&&xhr.setRequestHeader(i,this.opts.extraHeaders[i])}}catch(e){}if("POST"===
this.method)try{xhr.setRequestHeader("Content-type","text/plain;charset\x3dUTF-8")}catch(e){}try{xhr.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in xhr&&(xhr.withCredentials=this.opts.withCredentials);this.opts.requestTimeout&&(xhr.timeout=this.opts.requestTimeout);xhr.onreadystatechange=()=>{if(4===xhr.readyState)if(200===xhr.status||1223===xhr.status)this.onLoad();else this.setTimeoutFn(()=>{this.onError("number"===typeof xhr.status?xhr.status:0)},0)};debug("xhr data %s",this.data);
xhr.send(this.data)}catch(e){this.setTimeoutFn(()=>{this.onError(e)},0);return}"undefined"!==typeof document&&(this.index=Request.requestsCount++,Request.requests[this.index]=this)}onError(err){this.emitReserved("error",err,this.xhr);this.cleanup(!0)}cleanup(fromError){if("undefined"!==typeof this.xhr&&null!==this.xhr){this.xhr.onreadystatechange=empty;if(fromError)try{this.xhr.abort()}catch(e){}"undefined"!==typeof document&&delete Request.requests[this.index];this.xhr=null}}onLoad(){const data=
this.xhr.responseText;null!==data&&(this.emitReserved("data",data),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}}exports.Request=Request;Request.requestsCount=0;Request.requests={};"undefined"!==typeof document&&("function"===typeof attachEvent?attachEvent("onunload",unloadHandler):"function"===typeof addEventListener&&addEventListener("onpagehide"in require.globalThisShim?"pagehide":"unload",unloadHandler,!1))}
//# sourceMappingURL=module$node_modules$engine_DOT_io_client$build$cjs$transports$polling.js.map
